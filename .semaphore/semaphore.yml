version: v1.0
name: Prometheus Proxy CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2204

auto_cancel:
  running:
    when: branch != 'master'

global_job_config:
  env_vars:
    - name: JAVA_VERSION
      value: "17"
    - name: GRADLE_OPTS
      value: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
  prologue:
    commands:
      - checkout
      - sem-version java $JAVA_VERSION
      - cache restore gradle-wrapper-$(checksum gradle/wrapper/gradle-wrapper.properties)
      - cache restore gradle-deps-$(checksum build.gradle.kts)-$(checksum gradle/libs.versions.toml)
      - chmod +x gradlew

blocks:
  - name: Build
    dependencies: [ ]
    task:
      jobs:
        - name: Compile
          commands:
            - ./gradlew build -x test -x detekt -x lintKotlinMain -x lintKotlinTest
      epilogue:
        on_pass:
          commands:
            - cache store gradle-wrapper-$(checksum gradle/wrapper/gradle-wrapper.properties) ~/.gradle/wrapper
            - cache store gradle-deps-$(checksum build.gradle.kts)-$(checksum gradle/libs.versions.toml) ~/.gradle/caches

  - name: Lint
    dependencies: [ "Build" ]
    task:
      jobs:
        - name: Kotlinter
          commands:
            - ./gradlew lintKotlinMain lintKotlinTest
        - name: Detekt
          commands:
            - ./gradlew detekt

  - name: Unit Tests
    dependencies: [ "Build" ]
    task:
      jobs:
        - name: Agent Tests
          commands:
            - ./gradlew test --tests "io.prometheus.agent.*" --tests "io.prometheus.common.*"
          epilogue:
            always:
              commands:
                - test-results publish build/test-results/test/
        - name: Proxy Tests
          commands:
            - ./gradlew test --tests "io.prometheus.proxy.*" --tests "io.prometheus.misc.*"
          epilogue:
            always:
              commands:
                - test-results publish build/test-results/test/

  - name: Integration Tests
    dependencies: [ "Unit Tests" ]
    task:
      jobs:
        - name: InProcess Tests
          commands:
            - ./gradlew test --tests "io.prometheus.harness.InProcess*"
          epilogue:
            always:
              commands:
                - test-results publish build/test-results/test/
        - name: Netty Tests
          commands:
            - ./gradlew test --tests "io.prometheus.harness.Netty*"
          epilogue:
            always:
              commands:
                - test-results publish build/test-results/test/
        - name: TLS Tests
          commands:
            - ./gradlew test --tests "io.prometheus.harness.Tls*"
          epilogue:
            always:
              commands:
                - test-results publish build/test-results/test/

  - name: Build JARs
    dependencies: [ "Integration Tests", "Lint" ]
    task:
      jobs:
        - name: Shadow JARs
          commands:
            - ./gradlew agentJar proxyJar
            - artifact push workflow build/libs/prometheus-agent.jar
            - artifact push workflow build/libs/prometheus-proxy.jar

#promotions:
#  - name: Docker Push
#    pipeline_file: docker-push.yml
#    auto_promote:
#      when: branch = 'master' AND result = 'passed'
